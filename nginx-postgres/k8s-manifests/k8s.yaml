# From compose: db env values
apiVersion: v1
kind: Secret
metadata:
  name: pg-pass
type: Opaque
stringData:
  POSTGRES_PASSWORD: secret
  POSTGRES_USER: postgres
  POSTGRES_DB: demo
---
# From compose: volumes.db-data
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: db-data
spec:
  accessModes: [ "ReadWriteOnce" ]
  resources:
    requests:
      storage: 1Gi
---
# From compose: services.db image + env + volume mount
apiVersion: apps/v1
kind: Deployment
metadata:
  name: db
  labels: { app: db }
spec:
  replicas: 1
  selector: { matchLabels: { app: db } }
  template:
    metadata: { labels: { app: db } }
    spec:
      containers:
        - name: db
          image: postgres:15-alpine
          ports: [ { containerPort: 5432 } ]
          env:
            - name: POSTGRES_PASSWORD
              valueFrom: { secretKeyRef: { name: pg-pass, key: POSTGRES_PASSWORD } }
            - name: POSTGRES_USER
              valueFrom: { secretKeyRef: { name: pg-pass, key: POSTGRES_USER } }
            - name: POSTGRES_DB
              valueFrom: { secretKeyRef: { name: pg-pass, key: POSTGRES_DB } }
          volumeMounts:
            - name: data
              mountPath: /var/lib/postgresql/data
      volumes:
        - name: data
          persistentVolumeClaim: { claimName: db-data }
---
# From compose: services.db exposed internally
apiVersion: v1
kind: Service
metadata:
  name: db
  labels: { app: db }
spec:
  selector: { app: db }
  ports:
    - port: 5432
      targetPort: 5432
  type: ClusterIP
---
# From compose: services.web image + bind mount -> ConfigMap
apiVersion: apps/v1
kind: Deployment
metadata:
  name: web
  labels: { app: web }
spec:
  replicas: 1
  selector: { matchLabels: { app: web } }
  template:
    metadata: { labels: { app: web } }
    spec:
      containers:
        - name: web
          image: nginx:latest
          ports: [ { containerPort: 80 } ]
          volumeMounts:
            - name: site
              mountPath: /usr/share/nginx/html
      volumes:
        - name: site
          configMap:
            name: web-content
            items:
              - key: index.html
                path: index.html
              - key: styles.css
                path: styles.css
---
# From compose: services.web ports "8081:80" -> NodePort 30081
apiVersion: v1
kind: Service
metadata:
  name: web
  labels: { app: web }
spec:
  selector: { app: web }
  ports:
    - port: 80
      targetPort: 80
      nodePort: 30081
  type: NodePort
